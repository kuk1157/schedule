<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일정관리 게시판</title>
    <!-- css파일 적용-->
    <link href="/css/main.css" type="text/css" rel="stylesheet"/>
    <!-- font-awesome(폰트어썸) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css"
          integrity="sha512-q3eWabyZPc1XTCmF+8/LuE1ozpg5xxn7iO89yfSOd5/oKvyqLngoNGsx8jq92Y8eXJ/IRxQbEC+FGSYxtk2oiw=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@500&display=swap" rel="stylesheet">
    <script>
        $(document).ready(function () {
            getSchedules(); // 일정 전체 출력하기
            getWriters(); // 작성자 등록, 작성자 수정 SELECT 목록 불러오기
            getSearchList(); // 작성자 검색 목록( 일정작성한 작성자 목록만 출력하기 )
        })

        // 일정목록 상단에서 작성자 목록 출력 - schedule 테이블 활용
        function getSearchList(){
            $.ajax({
                type: 'GET',
                url: '/api/schedule/wList',
                success: function (response) {
                    for (let i = 0; i < response.length; i++) {
                        let data = response[i];
                        let w_id = data['w_id'];
                        let name = data['name'];
                        let tempHtml = `
                            <option value="${w_id}">${name}</option>
                        `;
                        $(".opt-value").after(tempHtml);
                    }
                }
            })
        }


        // 작성자 select박스 가져오기 - writer 테이블 활용
        function getWriters() {
            $.ajax({
                type: 'GET',
                url: '/api/writer',
                success: function (response) {
                    for (let i = 0; i < response.length; i++) {
                        let data = response[i];
                        let id = data['id'];
                        let name = data['name'];
                        let tempHtml = `
                            <option value="${id}">${name}</option>-->
                        `;
                        $('#writerList').append(tempHtml);
                        $(".writerSelect").append(tempHtml);
                    }
                }
            })
        }

        // 일정 전체 목록조회
        function getSchedules() {
            $('#scheduleList').empty();
            $.ajax({
                type: 'GET',
                url: '/api/schedule',
                success: function (response) {
                    for (let i = 0; i < response.length; i++) {
                        let message = response[i];
                        let id = message['id'];
                        let w_id = message['w_id'];
                        let memo = message['memo'];
                        let w_name = message['w_name'];
                        let name = message['name'];
                        let pw = message['pw'];
                        let reg_date = message['reg_date'];
                        let edit_date = message['edit_date'];

                        // <div class="time">
                        //     <i class="far fa-clock"></i>
                        //     <span>${reg_date}</span>
                        // </div>
                        let tempHtml = `
       <div class="guestList">
            <div class="infobox">
                <div class="nickname">
                    <i class="far fa-user-circle"></i>
                    <input type="hidden" class="wid-${id}" value="${w_id}">
                    <span class="w_name-${id}">${name}</span>
                    <select id="writer-${id}" class="writerSelect writer-${id}"></select>
                </div>


                <div class="time">
                    <i class="fas fa-user-edit"></i>
                    <span>${edit_date}</span>
                </div>
            </div>
            <div class="commbox">
                <div>
                    <span>
                        <span class="inputbox inputbox-${id}">
                            <span style="width:100%; float:left;">
                                <i class="fas fa-times cancelbtn" data-id="${id}"></i>
                                <textarea id="comment" class="memo-${id}">${memo}</textarea>
                            </span>
                        </span>
                        <span class="editbox editbox-${id}" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            <i class="fas fa-edit editbtn" data-id="${id}"></i>
                            ${memo}
                        </span>
                    </span>
                </div>
                <div class="btnbox">
                     <div style="width:50%; float:left;">
                         <input type="hidden" class="password-${id}" value="${pw}">
                          <span>비밀번호</span>
                          <input type="password" class="passwordCh-${id}">
                     </div>
                    <div style="width:50%; float:right;">
                        <button id="delbtn" class="delbtn" type="button" onclick="scheduleDelete(${id})">삭제</button>
                        <button id="upbtn_${id}" class="upbtn" type="button" value="N" onclick="scheduleEdit(${id})">수정</button>
                    </div>
                </div>
            </div>
        </div>
                        `;
                        // 선택한 영역에 HTML 뿌려주기
                        $('#scheduleList').append(tempHtml);

                    }
                }
            })
        }

        // 일정내용 체크
        function isValidMemo(memo) {
            if (memo == '') {
                alert('일정 내용을 입력해주시기 바랍니다.');
                return false;
            }
            if (memo.trim().length > 150) {
                alert('공백 포함 150자 이하로 입력해주세요');
                return false;
            }
            return true;
        }

        // 일정 등록
        function scheduleWrite() {
            let w_id = $("#writerList").val(); // 작성자 ID
            let memo = $(".memo").val(); // 일정내용
            let pw = $(".password").val(); // 비밀번호
            let pw_check = $(".password_ch").val(); // 비밀번호확인
            let data = {'w_id' : w_id, 'memo': memo, 'pw': pw, 'pw_check': pw_check};

            // console.log(data);
            // return false;

            // 일정내용 체크
            if (isValidMemo(memo) == "false") {
                return;
            }
            // 비밀번호 스크립트는 페이징 기능까지 넣고 나서 가장 마지막에 진행하기.
            if (pw != pw_check) {
                alert("비밀번호가 일치하지 않습니다. 다시 입력바랍니다.");
                return;
            }

            $.ajax({
                type: "POST",
                url: "/api/schedule",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    alert("일정 등록을 완료하였습니다.");
                    window.location.reload();
                }
            })
        }
        // upbtn누르면 비밀번호 입력란과 일정내용 인풋이 활성화되면서 수정가능하게
        // 고유번호를 가져와서 각각의 글들만 가능하도록 진행해야함

        // 목록에서 edit아이콘 클릭 - input 활성화
        $(document).on("click",".editbtn", function(){
            let id = $(this).data("id"); // 문서 ID
            // let select = $("#writer-"+id).val();
            // if(select === null){ // 간헐적으로 정보 못불어올떄 select 박스 api 재호출
            //     getWriters();
            // }
            let selected = $(".wid-"+id).val(); // 작성자 value구하기
            $("#writer-"+id).val(selected).prop("selected", true); // 수정값에 맞게 selected

            $(".inputbox-"+id).show(); // 인풋활성화
            $(".editbox-"+id).hide(); // 내용비활성화
            $(".writer-"+id).show(); // 작성자 수정 SELECT 활성화
            $(".w_name-"+id).hide(); // 기존 작성자 text 비활성화
             $("#upbtn_" + id).val("Y"); // 수정시 예외처리 조건값
        })

        // 목록에서 x아이콘 클릭 - input 비활성화 및 텍스트 보이게
        $(document).on("click",".cancelbtn", function(){
            let id = $(this).data("id"); // 문서 ID
            $(".editbox-"+id).show(); // 인풋활성화
            $(".inputbox-"+id).hide(); // 내용비활성화
            $(".writer-"+id).hide(); // 기존 작성자 text 활성화
            $(".w_name-"+id).show(); // 작성자 수정 SELECT 비활성화
            $("#upbtn_" + id).val("N"); // 수정시 예외처리 조건값
        })

        // 일정 수정
        function scheduleEdit(id) {
            let check = $(`#upbtn_${id}`).val();
            if(check == "N"){
                alert("수정 관련된 정보를 입력하고 수정해주시기 바랍니다.");
                return false;
            }
            let w_id = $(`#writer-${id}`).val(); // 작성자 ID
            let memo = $(`.memo-${id}`).val(); // 일정 내용
            let pw = $(`.password-${id}`).val();
            let pw_ch = $(`.passwordCh-${id}`).val();

            if(!pw_ch){
                alert("비밀번호를 입력하지 않았습니다.");
                return false;
            }

            if(pw != pw_ch){
                alert("비밀번호가 일치하지 않습니다. 다시 입력바랍니다.");
                return false;
            }
            let data = {'w_id': w_id, 'memo': memo};

            $.ajax({
                type: "PUT",
                url: `/api/schedule/${id}`,
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    alert('일정 수정을 완료하였습니다.');
                    window.location.reload();
                }
            });
        }

        // 일정 삭제.
        function scheduleDelete(id) {
            let pw = $(`.password-${id}`).val();
            let pw_ch = $(`.passwordCh-${id}`).val();

            if(!pw_ch){
                alert("비밀번호를 입력하지 않았습니다.");
                return false;
            }

            if(pw != pw_ch){
                alert("비밀번호가 일치하지 않습니다. 다시 입력바랍니다.");
                return false;
            }

            if(confirm("일정을 삭제하시겠습니까?")){
                $.ajax({
                    type: "DELETE",
                    url: `/api/schedule/${id}`,
                    success: function (response) {
                        alert('일정 삭제를 완료하였습니다.');
                        window.location.reload();
                    }
                })
            }
        }

        // schedule 테이블 활용
        function searchGet(){
            let w_id = $("#w-search-list").val() // 작성자 고유번호
            let memo = $(".searchInput").val(); // 일정내용
            let date = $("#date-search").val(); // 날짜 검색기능

            let data = {'w_id': w_id, 'memo': memo, "date" : date};
            console.log(data);
            // if(w_id == "" && memo == "" && date == ""){
            //     return false;
            // }
            $('#scheduleList').empty();

            $.ajax({
                type: 'GET',
                url: '/api/schedule/search',
                data : data,
                success: function (response) {
                    if(Array.isArray(response) && response.length === 0)  {
                        let tempHtml = `
                            <div class="nodata">
                                <span><i class="far fa-sad-tear"></i></span>
                                <span>조회된 데이터가 존재하지 않습니다.</span>
                            </div>
                        `;
                        $('#scheduleList').empty();
                        $('#scheduleList').append(tempHtml);
                        return false;
                    }

                    for (let i = 0; i < response.length; i++) {
                        let message = response[i];
                        let id = message['id'];
                        let w_id = message['w_id'];
                        let memo = message['memo'];
                        let w_name = message['w_name'];
                        let name = message['name'];
                        let pw = message['pw'];
                        let reg_date = message['reg_date'];
                        let edit_date = message['edit_date'];

                        // <div class="time">
                        //     <i class="far fa-clock"></i>
                        //     <span>${reg_date}</span>
                        // </div>

                        console.log(response);

                        if(message){
                        let tempHtml = `
       <div class="guestList">
            <div class="infobox">
                <div class="nickname">
                    <i class="far fa-user-circle"></i>
                    <span class="w_name-${id}">${name}</span>
                    <select id="writer-${id}" class="writerSelect writer-${id}"></select>
                </div>


                <div class="time">
                    <i class="fas fa-user-edit"></i>
                    <span>${edit_date}</span>
                </div>
            </div>
            <div class="commbox">
                <div>
                    <span>
                        <span class="inputbox inputbox-${id}">
                            <span style="width:100%; float:left;">
                                <i class="fas fa-times cancelbtn" data-id="${id}"></i>
                                <textarea id="comment" class="memo-${id}">${memo}</textarea>
                            </span>
                        </span>
                        <span class="editbox editbox-${id}" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            <i class="fas fa-edit editbtn" data-id="${id}"></i>
                            ${memo}
                        </span>
                    </span>
                </div>
                <div class="btnbox">
                     <div style="width:50%; float:left;">
                         <input type="hidden" class="password-${id}" value="${pw}">
                          <span>비밀번호</span>
                          <input type="password" class="passwordCh-${id}">
                     </div>
                    <div style="width:50%; float:right;">
                        <button id="delbtn" class="delbtn" type="button" onclick="scheduleDelete(${id})">삭제</button>
                        <button id="upbtn_${id}" class="upbtn" type="button" value="N" onclick="scheduleEdit(${id})">수정</button>
                    </div>
                </div>
            </div>
        </div>
                        `;
                            // 선택한 영역에 HTML 뿌려주기
                            $('#scheduleList').append(tempHtml);
                        }

                    }
                },
                error: function(xhr, status, error){
                    console.log(status, error);
                }

            })
        }
    </script>
</head>
<body>
<div class="background-header">

</div>
<div class="background-body">

</div>
<div class="wrap">
    <div class="header">
        <h2>schedule</h2>
        <p>
            일정을 입력해주세요.
        </p>
    </div>
    <div class="incFormWrap">
        <form method="POST">
            <div>
                <div class="join-tit">
                    <span>작성자</span>
                </div>
                <div class="main-inp">
                    <select id="writerList" name="w_id">
                    </select>
                </div>
            </div>
            <div>
                <div class="join-tit">
                    <span style="line-height:65px;">내용</span>
                </div>
                <div class="main-inp">
                    <textarea class="memo" name="memo"></textarea>
                </div>
            </div>
            <div>
                <div class="join-tit">
                    <span>비밀번호</span>
                </div>
                <div class="main-inp">
                    <input type="password" class="password" name="password">
                </div>
            </div>
            <div>
                <div class="join-tit">
                    <span>비밀번호확인</span>
                </div>
                <div class="main-inp">
                    <input type="password" class="password_ch" name="password_ch">
                </div>
            </div>
            <div style="width:92%;">
                <button type="button" class="joinBtn" onclick="scheduleWrite()">일정 작성</button>
            </div>
        </form>
    </div>

    <div class="listWrap">
        <form id="serachFrom" method="get">
            <div class="searchWrap">
                <button type="reset" onclick="getSchedules()">초기화</button>
                <button type="button" onclick="searchGet()">검색</button>
                <input type="text" class="searchInput" placeholder="일정 내용 입력">
                <select id="w-search-list">
                    <option class="opt-value" value="">작성자 검색</option>
                </select>
                <select id="date-search">
                    <option value="">기간 검색</option>
                    <option value="1">1일</option>
                    <option value="7">일주일</option>
                    <option value="30">1개월</option>
                    <option value="90">3개월</option>
                </select>
            </div>
            <div class="listbox" id="scheduleList">
            </div>
        </form>
    </div>

</div>
</body>
</html>


